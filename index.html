{% extends '_base.html' %}

{% block css %}
  {{ super() }}
  <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css">
  <link rel="stylesheet" type="text/css" href="css/convictions.css">
{% endblock css %}

{% block content %}

<div id="cover-page">
  <div class="bg-img"></div>
  <div class="bg-shade">
      <h1>{{ title }}</h1>
  </div>
  <div class="bg-clear"></div>
</div>

{% include "_credit_bar.html" %}

<div class="slides">
{% for section in sections %}
  <section id="{{ section.id }}">
  {% for slide in slides %}
  {% if slide.section_id == section.id %}
  <section id="{{ slide.id }}" class="{% if slide.class %}{{ slide.class }}{% endif %}">
    {% if slide.id == "conclude" %}
    {{ render_file("slides/{0}.html".format(slide.id))|safe }}
    {% else %}
    {{ render_file("slides/{0}.md".format(slide.id))|markdown }}
    {% endif %}
  </section>
  {% endif %}
  {% endfor %}
  </section>
{% endfor %}
</div>

{% endblock content %}

{% block library_scripts %}
{{ super() }}
<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.min.js"></script>
{% endblock %}

{% block scripts %}
<script src="js/convictions.js"></script>
<script src="js/convictions-charts.js"></script>
<script>
$(function() {
  // Data and URLs to data
  var DATA_BASE_URL = 'data';
  var COMMUNITY_AREAS_URL = DATA_BASE_URL + '/community_areas.json';
  var CHICAGO_URL = DATA_BASE_URL + '/chicago.json';
  var SUBURBS_URL = DATA_BASE_URL + '/suburbs.json';
  var CONVICTIONS_BY_COMMUNITY_AREA_AGE_18_24_URL = DATA_BASE_URL + '/convictions_by_community_area_18_24.json';
  var CONVICTIONS_BY_AGE_URL = DATA_BASE_URL + '/convictions_by_age.json';

  var CONVICTIONS_BY_TYPE = [{"value": 4183, "label": "Violent Index Crimes"}, {"value": 10477, "label": "Property Index Crimes"}, {"value": 48002, "label": "Drug Crimes"}];
  var CONVICTIONS_BY_SEX_AGE_18_24 = {"uknwn_sex": 2, "female": 3809, "male": 39769};
  var CONVICTIONS_DRUG_BY_CLASS = [{"label": "Manufacture or Delivery", "felony_1": {"label": "Class 1 Felony", "value": 5744}, "unkwn_class": {"label": "Unknown Class", "value": 4530}, "felony_4": {"label": "Class 4 Felony", "value": 1762}, "misd_b": {"label": "Class B Misdemeanor", "value": 25}, "felony_2": {"label": "Class 2 Felony", "value": 853}, "misd_a": {"label": "Class A Misdemeanor", "value": 691}, "felony_x": {"label": "Class X Felony", "value": 34}, "felony_3": {"label": "Class 3 Felony", "value": 1223}}, {"label": "Possession", "no_class": {"label": "No Class", "value": 1}, "felony_2": {"label": "Class 2 Felony", "value": 40}, "misd_a": {"label": "Class A Misdemeanor", "value": 74}, "felony_x": {"label": "Class X Felony", "value": 0}, "misd_c": {"label": "Class C Misdemeanor", "value": 32}, "felony_1": {"label": "Class 1 Felony", "value": 554}, "unkwn_class": {"label": "Unknown Class", "value": 16}, "felony_4": {"label": "Class 4 Felony", "value": 32127}, "misd_b": {"label": "Class B Misdemeanor", "value": 112}, "felony_3": {"label": "Class 3 Felony", "value": 189}}];
  var CONVICTIONS_DRUG_BY_TYPE = [{"other_drug": {"label": "Other Drug", "value": 8656}, "amphetamine": {"label": "Amphetamine", "value": 0}, "label": "Manufacture or Delivery", "heroin": {"label": "Heroin", "value": 2100}, "cannabis": {"label": "Cannabis", "value": 3694}, "cocaine": {"label": "Cocaine", "value": 3504}, "pcp": {"label": "PCP", "value": 8}, "lsd": {"label": "LSD", "value": 2}, "meth": {"label": "Methamphetamine", "value": 44}, "ecstasy": {"label": "Ecstasy", "value": 20}, "no_drug": {"label": "No Drug", "value": 4524}, "sched_1_2": {"label": "Schedule 1 & 2", "value": 16}}, {"ketamine": {"label": "Ketamine", "value": 0}, "label": "Possession", "other_drug": {"label": "Other Drug", "value": 38}, "ecstasy": {"label": "Ecstasy", "value": 40}, "barbituric": {"label": "Barbituric Acid", "value": 2}, "lsd": {"label": "LSD", "value": 2}, "cannabis": {"label": "Cannabis", "value": 1961}, "steroids": {"label": "Steroids", "value": 8}, "meth": {"label": "Methamphetamine", "value": 126}, "sched_1_2": {"label": "Schedule 1 & 2", "value": 6}, "amphetamine": {"label": "Amphetamine", "value": 0}, "heroin": {"label": "Heroin", "value": 64}, "pcp": {"label": "PCP", "value": 2}, "unkwn_drug": {"label": "Unknown Drug", "value": 30449}, "cocaine": {"label": "Cocaine", "value": 415}, "no_drug": {"label": "No Drug", "value": 1}, "morphine": {"label": "Morphine", "value": 2}}];

  // Slugs for drug charge classes in above data, in order of
  // increasing severity
  var DRUG_CHARGE_CLASSES = [
    'unkwn_class',
    'no_class',
    'misd_c',
    'misd_b',
    'misd_a',
    'felony_4',
    'felony_3',
    'felony_2',
    'felony_1',
    'felony_x'
  ];

  var DRUG_CLASS_COLORS = [
    '#66c2a5',
    '#fc8d62',
    '#8da0cb',
    '#e78ac3',
    '#a6d854',
    '#ffd92f',
    '#e5c494',
    '#b3b3b3'
  ];

  var DRUG_TYPES = [
    'other_drug',
    'amphetamine',
    'heroin',
    'cannabis',
    'cocaine',
    'pcp',
    'lsd',
    'meth',
    'ecstasy',
    'no_drug',
    'sched_1_2',
    'ketamine',
    'barbituric',
    'steroids',
    'unkwn_drug',
    'morphine'
  ];

  var DRUG_TYPE_COLORS = [
    '#a6cee3',
    '#1f78b4',
    '#b2df8a',
    '#33a02c',
    '#fb9a99',
    '#e31a1c',
    '#fdbf6f',
    '#ff7f00',
    '#cab2d6',
    '#6a3d9a',
    '#ffff99',
    '#b15928',
    '#8dd3c7',
    '#ffffb3',
    '#bebada'
  ];

  var renderChart = Convictions.renderChart;

  /**
   * Size the map container to the full height of the window
   */
  function sizeMapContainer(el) {
    var height = $(window).height() - $('#top-nav').height();
    $(el).height(height);
  }

  sizeMapContainer('#your-city-map-container');
  var chicagoMap = Convictions.createChicagoMap('#your-city-map-container', COMMUNITY_AREAS_URL, SUBURBS_URL, CHICAGO_URL, true);
  $(window).resize(_.debounce(function() {
    sizeMapContainer('#your-city-map-container');
    chicagoMap.invalidateSize();
  }, 1000));

  renderChart('#charges-categories-chart', Convictions.createCategoryChart,
    CONVICTIONS_BY_TYPE);

  renderChart('#drug-charges-class-chart', Convictions.createDrugChargeChart,
    CONVICTIONS_DRUG_BY_CLASS, DRUG_CHARGE_CLASSES, DRUG_CLASS_COLORS);

  renderChart('#drug-charges-type-chart', Convictions.createDrugChargeChart,
    CONVICTIONS_DRUG_BY_TYPE, DRUG_TYPES, DRUG_TYPE_COLORS);

  $.getJSON(CONVICTIONS_BY_AGE_URL, function(data) {
    renderChart('#convictions-by-age-chart', Convictions.createAgeChart,
      data);
    renderChart('#violent-convictions-by-age-chart', Convictions.createAgeChart,
      data, 'violent_convictions');
    renderChart('#drug-convictions-by-age-chart', Convictions.createAgeChart,
      data, 'drug_convictions');
  });

  // Download the JSONified version of the tarbell context
  $.getJSON('/data.json', function(data) {
     var glossary = data.glossary;
     var statistics = data.statistics;
     var popouts = data.popouts;

      Convictions.createCAFSexViz('#affecting-women-viz-container .viz-container', [
        {
          value: statistics.domestic_male.value,
          image: 'img/' + statistics.domestic_male.icon
        },
        {
          value: statistics.domestic_female.value,
          image: 'img/' + statistics.domestic_female.icon
        }
      ]);

     // Look for items with a 'data-term' attribute set and enable a
     // definition popover
     $('[data-term]').each(function() {
       var $el = $(this);
       var term = $el.data('term');
       var entry = glossary[term];

       $el.popover({
         content: entry.value,
         title: entry.label,
         trigger: 'click hover'
       });
     });

     // Look for items with "data-popout-id" attribute set and enable 
     // an explanation popover
     $("[data-popout-id]").each(function() {
       var $el = $(this);
       var id = $el.data('popout-id');
       var entry = popouts[id];

       $el.popover({
         content: entry.content,
         title: entry.title,
         trigger: 'click hover'
       });
     });

  })

  // Update the navigation highlighting as we scroll to
  // various sections in the page
  $('body').scrollspy({target: '#top-nav'})
    .on('activate.bs.scrollspy', function (e) {
      // Set the correct hash based on the scroll position
      var $target = $(e.target);
      var $anchor = $target.find('a.slide-circle');

      // we only care about slides, not sections
      if ($anchor.length == 1) {
        var hash = $anchor.attr('href');

        // update the history object instead of the
        // location's hash, so we don't jump around
        // when we scroll backwards
        if(history.replaceState) {
            history.replaceState(null, null, hash);
        }
        else {
            location.hash = hash;
        }
      }
    });
});
</script>
{% endblock %}
